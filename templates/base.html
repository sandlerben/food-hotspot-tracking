<!doctype html>
<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="static/css/main.css">
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization,places"></script>

	<script>
		var map, pointarray, heatmap, tweetGeoData;
		
		function initialize() {

			var mapOptions = {
				zoom: 6,
				center: new google.maps.LatLng(1, 38), // middle of Kenya
				mapTypeId: google.maps.MapTypeId.MAP
			};
			
			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

			service = new google.maps.places.PlacesService(map);

            var pointArray = new google.maps.MVCArray();

            {% for tweet in all_tweets %}
                {% if tweet.lat %}
                    pointArray.push(new google.maps.LatLng({{ tweet.lat }}, {{ tweet.lon }}));
                {% elif tweet.loc %}
                    var request = {
                        query: '{{ tweet.loc }}',
                    };
                    service.textSearch(request, callback);
                {% endif %}
            {% endfor %}    


			heatmap = new google.maps.visualization.HeatmapLayer({
				data: pointArray
			});

			heatmap.setMap(map);
		}

		function callback(results, status) {
            console.log("What");
			if (status == google.maps.places.PlacesServiceStatus.OK) {
				var place = results[0];

				if (typeof(place) !== 'undefined') {
					var loc = place.geometry.location;
					// console.log('pushing ' + loc.toString() + ' to geoData');
					pointArray.push(loc); 
				}	
			}
		}

		google.maps.event.addDomListener(window, 'load', initialize);

	</script>
    <script type="text/javascript" src="static/js/masonry.min.js"></script>
</head>

<body>
	{% include 'header.html' %}
	<div id="map-wrapper">
		<div id="map-canvas"></div>
	</div>
	<main>
		<h1>Recent tweets in the area</h1>
		<h6><center>Last scanned twitter at {{ most_recent_tweets[0].timestamp.strftime("%H:%M %p on %Y-%m-%d.") }}</center></h6>
		<ul id="container">
            {% for tweet in most_recent_tweets %}
            <li class="item">{{ tweet.html|safe }}</li>
            {% endfor %}
        </ul>
	</main>
	<footer>
		<div class="wrapper">
			Built at Hack the Change 2014 by Max McCarthy, Yoni Nachmany, and Ben Sandler.
		</div>
	</footer>

    
</body>

<script type="text/javascript">
    var container = document.querySelector('#container');
    var msnry = new Masonry( container, {
        columnWidth: 505,
        itemSelector: '.item',
        gutter: 10,
        isFitWidth: true,
    });

    msnry.bindResize();

    msnry.layout();

</script>

</html>